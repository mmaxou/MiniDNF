import{_ as te,r as i,o as ae,b as O,g as w,a as se,c as R,d as $,e as re,f as oe,h as le,i as m,j as t,t as d,k as T,F as ne,l as ie,w as ce,m as S,n as V,v as de,p as ue,q as A,s as H,u as me,x as be,y as x,z as _,A as ve,B as fe,C as he,D as I,E as ye,G as b,H as pe}from"./index-CGzUXEtr.js";const ge={class:"container mt-4"},_e={class:"d-flex justify-content-between align-items-center mb-4"},Ce={class:"badge text-bg-info fs-6"},De={class:"row"},we={class:"card h-100 character-card"},$e={class:"card-body"},xe={class:"card-title"},Te={class:"d-flex gap-2 mb-3"},Se={class:"badge text-bg-primary"},ke={class:"badge text-bg-secondary"},Me={class:"last-play-time mb-3"},Pe={class:"text-muted"},Le={class:"d-flex gap-2"},Re=["onClick"],Ie=["onClick"],Ue={class:"modal fade",id:"createCharacterModal",tabindex:"-1","aria-labelledby":"createCharacterModalLabel","aria-hidden":"true"},Fe={class:"modal-dialog"},je={class:"modal-content"},Ee={class:"modal-body"},Ne={class:"mb-3"},qe={class:"mb-3"},Be={key:0,class:"alert alert-danger",role:"alert"},Oe={class:"modal-footer"},Ve=["disabled"],Ae={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},He={class:"modal fade",id:"characterDetailModal",tabindex:"-1","aria-labelledby":"characterDetailModalLabel","aria-hidden":"true"},Ge={class:"modal-dialog"},ze={class:"modal-content"},Je={key:0,class:"modal-body"},Ye={class:"modal-footer"},Ke=["disabled"],Qe={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},We={__name:"CharacterList",setup(Xe){const v=i([]),f=i(""),C=i(""),D=i(null),c=i(!1),U=i(""),G=ye(),k=i(null),M=i(null);let F=null,P=null,L=null;ae(()=>{var e;k.value=new O.Modal(document.getElementById("createCharacterModal")),M.value=new O.Modal(document.getElementById("characterDetailModal"));const s=w();U.value=((e=s.currentUser)==null?void 0:e.email)||"未知用户",s.currentUser&&z(s.currentUser.uid)}),se(()=>{P&&P(),L&&L()});const z=s=>{const e=R();F=$(e,`users/${s}/characters`),L=re(F,r=>{if(r.exists()){const o=r.val();v.value=Object.entries(o).map(([l,n])=>({id:l,...n,lastPlayTime:null})),J(s,o),Y(s)}else v.value=[]});const a=oe(_,`users/${s}/characters`);P=le(a,r=>{r.docChanges().forEach(async o=>{const l=o.doc.data(),n=o.doc.id;if(o.type==="modified"){const h=$(e,`users/${s}/characters/${n}`),y=await A(h);if(y.exists()){const g=y.val();await H(h,{...g,name:l.name,class:l.class,level:l.level})}const p=v.value.findIndex(g=>g.id===n);p!==-1&&l.lastPlayTime&&(v.value[p].lastPlayTime=l.lastPlayTime)}})})},J=async(s,e)=>{try{for(const[a,r]of Object.entries(e))if(r.lastPlayTime){const o=x(_,`users/${s}/characters/${a}`),l=await I(o);if(l.exists()){const n=l.data();if(!n.lastPlayTime||new Date(r.lastPlayTime)>new Date(n.lastPlayTime)){const h=new Date(r.lastPlayTime),p=new Date(h.getTime()+8*60*60*1e3).toISOString();await pe(o,{lastPlayTime:p}),console.log(`已迁移角色 ${r.name} 的最后游戏时间到Firestore（转换为北京时间）`)}}}}catch(a){console.error("迁移最后游戏时间数据失败:",a)}},Y=async s=>{try{for(const e of v.value){const a=x(_,`users/${s}/characters/${e.id}`),r=await I(a);if(r.exists()){const o=r.data();o.lastPlayTime&&(e.lastPlayTime=o.lastPlayTime)}}}catch(e){console.error("从Firestore获取最后游戏时间失败:",e)}},j=async s=>{var e;try{const r=(e=w().currentUser)==null?void 0:e.uid;if(r){const o=x(_,`users/${r}/characters/${s.id}`),l=await I(o);if(l.exists()){const n=l.data();s={...s,lastPlayTime:n.lastPlayTime||null}}}}catch(a){console.error("获取最新角色数据失败:",a)}G.push({name:"game",query:{character:JSON.stringify(s)}})},K=()=>{f.value="",C.value="",u.value="",k.value.show()},u=i(""),E=async()=>{var a;if(!f.value.trim()||!C.value){u.value="请填写角色名称和选择职业";return}u.value="",c.value=!0;const e=(a=w().currentUser)==null?void 0:a.uid;try{const r=R(),o=$(r,"users"),l=await A(o);let n=!1;if(l.exists()){const q=l.val();for(const Z in q){const B=q[Z].characters||{};for(const ee in B)if(B[ee].name===f.value){n=!0;break}if(n)break}}if(n){u.value="该角色名称已被使用，请选择其他名称";return}const h=$(r,`users/${e}/characters`),y=be(h),p=y.key,g={name:f.value,class:C.value,level:1,createdAt:new Date().toISOString()};await H(y,g);const X=x(_,`users/${e}/characters/${p}`);await ve(X,{...g,lastPlayTime:null,stats:{hp:100,mp:50,strength:10,intelligence:10,vitality:10,spirit:10},currency:{points:0,gold:1e3},equipment:{},inventory:{},skills:{},quests:{}}),k.value.hide()}catch(r){console.error("创建角色失败:",r),u.value="创建角色失败，请稍后重试"}finally{c.value=!1}},N=async s=>{var r;if(!s||!confirm(`确定要删除角色「${s.name}」吗？
此操作不可恢复。`))return;c.value=!0;const a=(r=w().currentUser)==null?void 0:r.uid;try{const o=R(),l=$(o,`users/${a}/characters/${s.id}`);await fe(l);const n=x(_,`users/${a}/characters/${s.id}`);await he(n),M.value&&M.value.hide()}catch(o){console.error("删除角色失败:",o),alert("删除角色失败，请稍后重试")}finally{c.value=!1}},Q=async()=>{const s=w();try{await me(s),console.log("退出登录成功")}catch(e){console.error("退出登录失败:",e)}},W=s=>{if(!s)return"从未登录";try{const e=new Date(s),a=new Date;a.setHours(0,0,0,0);const r=new Date(a);r.setDate(r.getDate()-1);let o;e>=a?o="今天":e>=r?o="昨天":o=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`;const l=`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`;return`最后游戏: ${o} ${l}`}catch(e){return console.error("格式化时间错误:",e),"时间格式错误"}};return(s,e)=>(b(),m("div",ge,[t("div",_e,[t("span",Ce,"当前账号："+d(U.value),1),t("button",{class:"btn btn-outline-danger",onClick:Q},e[4]||(e[4]=[t("i",{class:"bi bi-box-arrow-right me-2"},null,-1),T("退出登录 ")]))]),e[15]||(e[15]=t("h2",{class:"text-center mb-4"},"角色管理",-1)),t("div",De,[(b(!0),m(ne,null,ie(v.value,a=>(b(),m("div",{key:a.id,class:"col-md-4 mb-4"},[t("div",we,[t("div",$e,[t("h5",xe,d(a.name),1),t("div",Te,[t("span",Se,"Lv"+d(a.level),1),t("span",ke,d(a.class),1)]),t("div",Me,[t("small",Pe,[e[5]||(e[5]=t("i",{class:"bi bi-clock"},null,-1)),T(" "+d(W(a.lastPlayTime)),1)])]),t("div",Le,[t("button",{class:"btn btn-sm btn-primary",onClick:r=>j(a)},"开始游戏",8,Re),t("button",{class:"btn btn-sm btn-danger",onClick:r=>N(a)},"删除角色",8,Ie)])])])]))),128)),t("div",{class:"col-md-4 mb-4"},[t("div",{class:"card h-100 create-character-card",onClick:K},e[6]||(e[6]=[t("div",{class:"card-body d-flex align-items-center justify-content-center"},[t("div",{class:"text-center"},[t("i",{class:"bi bi-plus-circle fs-1"}),t("h5",{class:"mt-2"},"创建新角色")])],-1)]))])]),t("div",Ue,[t("div",Fe,[t("div",je,[e[12]||(e[12]=t("div",{class:"modal-header"},[t("h5",{class:"modal-title",id:"createCharacterModalLabel"},"创建新角色"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),t("div",Ee,[t("form",{onSubmit:ce(E,["prevent"])},[t("div",Ne,[e[7]||(e[7]=t("label",{for:"characterName",class:"form-label"},"角色名称",-1)),V(t("input",{type:"text",class:"form-control",id:"characterName","onUpdate:modelValue":e[0]||(e[0]=a=>f.value=a),required:""},null,512),[[de,f.value]])]),t("div",qe,[e[9]||(e[9]=t("label",{for:"characterClass",class:"form-label"},"职业",-1)),V(t("select",{class:"form-select",id:"characterClass","onUpdate:modelValue":e[1]||(e[1]=a=>C.value=a),required:""},e[8]||(e[8]=[t("option",{value:""},"请选择职业",-1),t("option",{value:"鬼剑士"},"鬼剑士",-1),t("option",{value:"神枪手"},"神枪手",-1),t("option",{value:"格斗家"},"格斗家",-1)]),512),[[ue,C.value]])]),u.value?(b(),m("div",Be,d(u.value),1)):S("",!0)],32)]),t("div",Oe,[e[11]||(e[11]=t("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"取消",-1)),t("button",{type:"button",class:"btn btn-primary",onClick:E,disabled:c.value},[c.value?(b(),m("span",Ae)):S("",!0),e[10]||(e[10]=T(" 创建 "))],8,Ve)])])])]),t("div",He,[t("div",Ge,[t("div",ze,[e[14]||(e[14]=t("div",{class:"modal-header"},[t("h5",{class:"modal-title",id:"characterDetailModalLabel"},"角色详情"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),D.value?(b(),m("div",Je,[t("h4",null,d(D.value.name),1),t("p",null,"等级: "+d(D.value.level),1)])):S("",!0),t("div",Ye,[t("button",{type:"button",class:"btn btn-danger",onClick:e[2]||(e[2]=a=>N(D.value)),disabled:c.value},[c.value?(b(),m("span",Qe)):S("",!0),e[13]||(e[13]=T(" 删除角色 "))],8,Ke),t("button",{type:"button",class:"btn btn-primary",onClick:e[3]||(e[3]=a=>j(D.value))}," 开始游戏 ")])])])])]))}},et=te(We,[["__scopeId","data-v-525b019e"]]);export{et as default};
